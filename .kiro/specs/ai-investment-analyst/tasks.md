# 实施计划

## 当前状态
- **项目基础架构**: ✅ 已完成 (配置管理、日志系统、异常处理、设备检测)
- **测试覆盖率**: 53% (14/14 测试通过)
- **下一步**: 开始任务2 - 核心数据模型和接口定义

- [x] 1. 项目基础架构搭建
  - 创建项目目录结构和基础配置文件
  - 实现配置管理系统，支持YAML配置加载和环境切换
  - 设置日志系统和异常处理基础框架
  - 实现设备检测和优化工具（CUDA/MPS/CPU自动检测）
  - _需求: 需求3.2, 需求6.1, 需求6.2, 需求6.5_

- [x] 2. 核心数据模型和接口定义
  - 定义Document、Chunk、Table等核心数据类
  - 实现InvestmentQuery、AnalysisResult、SourceCitation数据模型
  - 创建所有模块的抽象基类和接口定义
  - 编写数据模型的单元测试
  - _需求: 需求1.2, 需求6.1, 需求6.3_

- [x] 3. 文档处理模块实现
  - [ ] 3.1 高保真表格提取实现
    - 使用pdfplumber遍历PDF页面，提取所有结构化表格
    - 将每个表格序列化为Markdown字符串，作为独立的高质量"子分块"
    - 记录每个表格所在的页码和边界框信息
    - 编写表格提取的单元测试
    - _需求: 需求1.1, 需求1.2_

  - [ ] 3.2 高保真文本提取实现
    - 使用unstructured解析PDF，传入从pdfplumber获得的表格边界框列表
    - 指示unstructured跳过表格区域，避免重复处理
    - 返回剩余的文本元素（标题、段落、列表等）
    - 编写文本提取的单元测试
    - _需求: 需求1.3, 需求1.4_

  - [ ] 3.3 文本二次分块实现
    - 对从unstructured获得的较长文本段落进行语义分块或递归字符分块
    - 形成更多细粒度的"子分块"
    - 保持文本语义的完整性和连贯性
    - 编写文本分块的单元测试
    - _需求: 需求1.4_

  - [ ] 3.4 父子关系构建实现
    - 定义"父分块"为完整的页面内容或逻辑章节
    - 创建"子分块"，包括表格Markdown和文本小块
    - 为每个"子分块"添加元数据（内容、源页码、所属父分块ID）
    - 编写父子关系构建的单元测试
    - _需求: 需求2.1, 需求2.2_

- [ ] 4. 模型管理系统开发
  - [x] 4.1 基础模型加载器
    - 实现Qwen2.5-7B模型的加载和初始化
    - 配置4bit量化支持以优化内存使用
    - 集成现有设备检测工具进行自动设备选择
    - 添加模型加载的错误处理和重试机制
    - _需求: 需求7.1, 需求3.6, 需求6.2_

  - [ ] 4.2 嵌入和重排模型集成
    - 集成BAAI/bge-m3嵌入模型
    - 集成BAAI/bge-reranker-large重排模型
    - 实现模型的批量推理优化
    - 编写模型管理的单元测试
    - _需求: 需求7.2, 需求7.3_

  - [ ] 4.3 内存优化和性能监控
    - 实现动态内存管理和模型卸载
    - 集成现有设备管理器的内存优化功能
    - 实现模型并行和批处理优化
    - 编写性能监控测试
    - _需求: 需求3.6, 需求8.5_

- [ ] 5. 父子文档检索系统构建
  - [ ] 5.1 子分块向量数据库实现
    - 使用FAISS IndexHNSWFlat为所有子分块构建向量索引
    - 实现子分块向量化和索引构建流程
    - 支持增量索引更新和持久化存储
    - 编写子分块向量索引的单元测试
    - _需求: 需求2.3, 需求7.3_

  - [ ] 5.2 父分块文档存储实现
    - 实现键值存储，以父分块ID为键存储完整的父分块内容
    - 支持快速的父分块内容检索和更新
    - 实现父分块存储的持久化机制
    - 编写父分块存储的单元测试
    - _需求: 需求2.3_

  - [ ] 5.3 父子文档检索实现
    - 在向量数据库中检索最相关的"子分块"
    - 从子分块元数据中提取对应的"父分块"ID
    - 从文档存储中取出完整的"父分块"内容
    - 编写父子文档检索的集成测试
    - _需求: 需求2.5, 需求2.6_

  - [ ] 5.4 检索结果优化
    - 实现父分块去重和相关性排序算法
    - 添加检索质量评估和监控
    - 优化检索性能，确保响应时间<1秒
    - 编写检索优化的性能测试
    - _需求: 需求2.8, 需求3.4_

- [ ] 6. Prompt工程和管理系统
  - [ ] 6.1 Prompt模板管理
    - 创建版本化的Prompt模板文件结构
    - 实现动态Prompt加载和模板变量替换
    - 支持多版本Prompt的A/B测试
    - 编写Prompt管理的单元测试
    - _需求: 需求2.1, 需求2.3_

  - [ ] 6.2 多视角查询重写
    - 实现查询的三视角扩展（直接、简化、扩展）
    - 设计查询重写的Prompt模板
    - 优化查询扩展的质量和相关性
    - 编写查询重写的功能测试
    - _需求: 需求2.1_

  - [ ] 6.3 段永平风格对齐Prompt
    - 收集和分析段永平投资理念语料
    - 设计风格对齐的Prompt模板
    - 实现风格一致性检查和优化
    - 编写风格对齐的评估测试
    - _需求: 需求1.3, 需求4.3_

- [ ] 7. 核心RAG逻辑实现
  - [ ] 7.1 查询处理管道
    - 实现完整的查询处理流程，集成查询重写、父子文档检索、生成各模块
    - 确保将完整的父分块内容提交给LLM进行答案生成
    - 添加处理时间监控和性能优化
    - 编写端到端的集成测试
    - _需求: 需求2.4, 需求2.6, 需求3.4_

  - [ ] 7.2 反思修正链实现
    - 实现初稿生成和反思修正的两阶段生成
    - 设计反思修正的评估维度和标准
    - 优化修正链的质量和效率
    - 编写反思修正的功能测试
    - _需求: 需求2.3, 需求2.4_

  - [ ] 7.3 引用追溯和格式化
    - 实现准确的原文引用提取和标注
    - 设计引用信息的结构化存储
    - 实现引用质量验证和检查
    - 编写引用功能的准确性测试
    - _需求: 需求1.4, 需求8.6_

- [ ] 8. Web界面开发
  - [ ] 8.1 Gradio基础界面
    - 创建清洁的问答界面布局
    - 实现用户查询输入和结果展示
    - 添加对话历史管理功能
    - 编写界面交互的功能测试
    - _需求: 需求5.1, 需求5.2_

  - [ ] 8.2 引用文献展示区域
    - 设计专门的引用文献展示组件
    - 实现引用内容的高亮和链接
    - 添加引用来源的详细信息展示
    - 编写引用展示的界面测试
    - _需求: 需求5.2, 需求5.6_

  - [ ] 8.3 知识库管理功能
    - 实现PDF文档上传和处理界面
    - 添加知识库状态监控和管理
    - 支持实时知识库更新和重建
    - 编写知识库管理的集成测试
    - _需求: 需求5.3, 需求5.4_

- [ ] 9. 评估和质量保证系统
  - [ ] 9.1 自动化评估框架
    - 集成ragas评估框架进行量化评估
    - 实现faithfulness、relevancy、precision指标计算
    - 创建标准评测数据集和基准测试
    - 编写评估框架的验证测试
    - _需求: 需求4.2, 需求8.1_

  - [ ] 9.2 LLM-as-a-Judge评估
    - 实现多维度的风格和质量评估
    - 设计段永平风格的评估标准和Prompt
    - 添加评估结果的统计分析和报告
    - 编写LLM评估的准确性测试
    - _需求: 需求4.3, 需求8.2_

  - [ ] 9.3 性能监控和报告
    - 实现系统性能指标的实时监控
    - 创建详细的评估报告生成功能
    - 添加异常检测和质量预警机制
    - 编写监控系统的可靠性测试
    - _需求: 需求8.4, 需求8.5_

- [ ] 10. 模型对齐训练系统
  - [ ] 10.1 对齐数据集构建
    - 创建DPO和KTO训练数据的构建脚本
    - 实现chosen/rejected对的自动生成
    - 添加数据质量检查和清洗功能
    - 编写数据集构建的验证测试
    - _需求: 需求4.1, 需求4.6_

  - [ ] 10.2 DPO训练实现
    - 使用transformers和trl实现DPO训练
    - 配置LoRA微调参数和超参数搜索
    - 集成Weights & Biases进行实验跟踪
    - 编写DPO训练的功能测试
    - _需求: 需求4.1, 需求4.5_

  - [ ] 10.3 KTO训练实现
    - 实现KTO对齐训练的完整流程
    - 支持与DPO训练的对比实验
    - 添加训练过程的监控和早停机制
    - 编写KTO训练的性能测试
    - _需求: 需求4.1, 需求4.4_

- [ ] 11. 部署和运维系统
  - [ ] 11.1 Docker容器化
    - 创建生产级的Dockerfile和构建脚本
    - 实现docker-compose服务编排配置
    - 支持GPU和CPU环境的自动适配
    - 编写容器化部署的集成测试
    - _需求: 需求3.1, 需求3.3_

  - [ ] 11.2 云端部署脚本
    - 开发自动化的云端部署脚本
    - 实现环境检查和依赖安装自动化
    - 添加服务健康检查和故障恢复
    - 编写部署脚本的可靠性测试
    - _需求: 需求3.1, 需求3.3_

  - [ ] 11.3 生产监控增强
    - 集成系统监控和性能指标收集
    - 扩展现有日志系统支持生产环境
    - 添加告警机制和异常通知
    - 编写监控系统的完整性测试
    - _需求: 需求5.4, 需求6.5, 需求8.4_

- [ ] 12. 系统集成和优化
  - [ ] 12.1 端到端集成测试
    - 实现完整的用户场景测试
    - 验证所有模块间的接口和数据流
    - 测试并发访问和负载处理能力
    - 编写系统集成的回归测试
    - _需求: 需求3.4, 需求3.5, 需求6.3_

  - [ ] 12.2 性能优化和调优
    - 优化查询响应时间至10秒以内
    - 调优内存使用控制在20GB以内
    - 提升并发处理能力支持5+用户
    - 编写性能优化的基准测试
    - _需求: 需求3.4, 需求3.5, 需求3.6_

  - [ ] 12.3 最终验收和交付
    - 执行完整的验收测试和质量检查
    - 生成详细的项目文档和用户手册
    - 完成DPO vs KTO的对比分析报告
    - 准备一键启动的部署包和演示
    - _需求: 需求4.4, 需求6.1, 需求8.3_