# 实施计划

## 当前状态
- **项目基础架构**: ✅ 已完成 (配置管理、日志系统、异常处理、设备检测)
- **核心数据模型**: ✅ 已完成 (Document、Chunk、Table等核心数据类)
- **文档处理模块**: ✅ 已完成 (高保真表格提取、文本提取、父子分块)
- **基础模型加载器**: ✅ 已完成 (Qwen2.5-7B模型加载、4bit量化、设备检测)
- **测试覆盖率**: 80%+ (所有核心功能测试通过)
- **下一步**: 开始任务4.2 - 嵌入和重排模型集成

- [x] 1. 项目基础架构搭建
  - 创建项目目录结构和基础配置文件
  - 实现配置管理系统，支持YAML配置加载和环境切换
  - 设置日志系统和异常处理基础框架
  - 实现设备检测和优化工具（CUDA/MPS/CPU自动检测）
  - _需求: 需求3.2, 需求6.1, 需求6.2, 需求6.5_

- [x] 2. 核心数据模型和接口定义
  - 定义Document、Chunk、Table等核心数据类
  - 实现InvestmentQuery、AnalysisResult、SourceCitation数据模型
  - 创建所有模块的抽象基类和接口定义
  - 编写数据模型的单元测试
  - _需求: 需求1.2, 需求6.1, 需求6.3_

- [x] 3. 文档处理模块实现
  - [x] 3.1 高保真表格提取实现
    - 使用pdfplumber遍历PDF页面，提取所有结构化表格
    - 将每个表格序列化为Markdown字符串，作为独立的高质量"子分块"
    - 记录每个表格所在的页码和边界框信息
    - 编写表格提取的单元测试
    - _需求: 需求1.1, 需求1.2_

  - [x] 3.2 高保真文本提取实现
    - 使用unstructured解析PDF，传入从pdfplumber获得的表格边界框列表
    - 指示unstructured跳过表格区域，避免重复处理
    - 返回剩余的文本元素（标题、段落、列表等）
    - 编写文本提取的单元测试
    - _需求: 需求1.3, 需求1.4_

  - [x] 3.3 文本二次分块实现
    - 对从unstructured获得的较长文本段落进行语义分块或递归字符分块
    - 形成更多细粒度的"子分块"
    - 保持文本语义的完整性和连贯性
    - 编写文本分块的单元测试
    - _需求: 需求1.4_

  - [x] 3.4 父子关系构建实现
    - 定义"父分块"为完整的页面内容或逻辑章节
    - 创建"子分块"，包括表格Markdown和文本小块
    - 为每个"子分块"添加元数据（内容、源页码、所属父分块ID）
    - 编写父子关系构建的单元测试
    - _需求: 需求2.1, 需求2.2_

- [x] 4. 模型管理系统开发
  - [x] 4.1 基础模型加载器
    - 实现Qwen2.5-7B模型的加载和初始化
    - 配置4bit量化支持以优化内存使用
    - 集成现有设备检测工具进行自动设备选择
    - 添加模型加载的错误处理和重试机制
    - _需求: 需求7.1, 需求3.6, 需求6.2_

  - [ ] 4.2 嵌入和重排模型集成
    - 集成BAAI/bge-m3嵌入模型到ModelManager
    - 集成BAAI/bge-reranker-large重排模型
    - 实现嵌入模型的批量推理优化
    - 实现重排模型的批量处理
    - 编写嵌入和重排模型的单元测试
    - _需求: 需求7.2, 需求7.3_

  - [ ] 4.3 内存优化和性能监控增强
    - 扩展现有ModelManager的内存管理功能
    - 实现多模型并行加载和卸载策略
    - 添加模型推理性能监控和优化
    - 实现模型间内存共享和优化
    - 编写性能监控和优化测试
    - _需求: 需求3.6, 需求8.5_

- [ ] 5. 父子文档检索系统构建
  - [ ] 5.1 向量数据库和存储系统实现
    - 使用FAISS IndexHNSWFlat为所有子分块构建向量索引
    - 实现键值存储，以父分块ID为键存储完整的父分块内容
    - 集成BGE-M3嵌入模型进行子分块向量化
    - 支持增量索引更新和持久化存储
    - 编写向量数据库和存储系统的单元测试
    - _需求: 需求2.3, 需求7.3_

  - [ ] 5.2 父子文档检索核心逻辑
    - 实现ParentChildRetrievalSystem类
    - 在向量数据库中检索最相关的"子分块"
    - 从子分块元数据中提取对应的"父分块"ID
    - 从文档存储中取出完整的"父分块"内容
    - 集成BGE-Reranker进行检索结果重排序
    - 编写父子文档检索的集成测试
    - _需求: 需求2.5, 需求2.6, 需求7.3_

  - [ ] 5.3 检索性能优化和监控
    - 实现父分块去重和相关性排序算法
    - 添加检索质量评估和监控指标
    - 优化检索性能，确保响应时间<1秒
    - 实现批量检索和缓存机制
    - 编写检索优化的性能测试
    - _需求: 需求2.8, 需求3.4_

- [ ] 6. Prompt工程和管理系统
  - [ ] 6.1 Prompt模板管理系统
    - 创建prompts/目录下的版本化Prompt模板文件结构
    - 实现PromptManager类，支持动态Prompt加载和模板变量替换
    - 支持多版本Prompt的A/B测试和配置切换
    - 集成到现有配置管理系统
    - 编写Prompt管理的单元测试
    - _需求: 需求2.1, 需求2.3_

  - [ ] 6.2 多视角查询重写实现
    - 实现QueryRewriter类，支持查询的三视角扩展（直接、简化、扩展）
    - 设计查询重写的Prompt模板（query_rewriting/v1_multi_perspective.txt）
    - 集成到ModelManager，使用Qwen2.5进行查询重写
    - 优化查询扩展的质量和相关性
    - 编写查询重写的功能测试
    - _需求: 需求2.1_

  - [ ] 6.3 段永平风格对齐Prompt开发
    - 收集和分析段永平投资理念语料，构建风格语料库
    - 设计风格对齐的Prompt模板（style_alignment/v1_dyp_style.txt）
    - 实现StyleAligner类，进行风格一致性检查和优化
    - 集成LLM-as-a-Judge评估风格对齐质量
    - 编写风格对齐的评估测试
    - _需求: 需求1.3, 需求4.3_

- [ ] 7. 核心RAG逻辑实现
  - [ ] 7.1 ValueSeekerRAG核心类实现
    - 实现ValueSeekerRAG类，集成查询重写、父子文档检索、生成各模块
    - 实现完整的查询处理流程：查询重写 -> 文档检索 -> 上下文构建 -> 答案生成
    - 确保将完整的父分块内容提交给LLM进行答案生成
    - 集成现有的ModelManager、ParentChildRetrievalSystem、PromptManager
    - 添加处理时间监控和性能优化
    - 编写端到端的集成测试
    - _需求: 需求2.4, 需求2.6, 需求3.4_

  - [ ] 7.2 反思修正链和风格对齐
    - 实现初稿生成和反思修正的两阶段生成流程
    - 集成段永平风格对齐Prompt，确保回答风格一致性
    - 设计反思修正的评估维度和标准
    - 优化修正链的质量和效率，控制生成时间
    - 编写反思修正和风格对齐的功能测试
    - _需求: 需求2.3, 需求2.4, 需求1.3_

  - [ ] 7.3 引用追溯和结果格式化
    - 实现准确的原文引用提取和标注，基于父子分块关系
    - 设计ParentChunkCitation引用信息的结构化存储
    - 实现引用质量验证和检查，确保引用准确性
    - 格式化最终的AnalysisResult，包含答案、引用、置信度等
    - 编写引用功能的准确性测试
    - _需求: 需求1.4, 需求8.6_

- [ ] 8. Web界面开发
  - [ ] 8.1 Gradio核心界面实现
    - 创建基于Gradio的清洁问答界面布局
    - 实现用户查询输入和ValueSeekerRAG结果展示
    - 集成对话历史管理和会话状态保持
    - 添加加载状态指示和错误处理显示
    - 编写界面交互的功能测试
    - _需求: 需求5.1, 需求5.2_

  - [ ] 8.2 引用文献和来源展示
    - 设计专门的引用文献展示组件，展示ParentChunkCitation信息
    - 实现引用内容的高亮显示和页码链接
    - 添加引用来源的详细信息展示（文件名、页码、相关性分数）
    - 支持引用内容的展开/折叠和复制功能
    - 编写引用展示的界面测试
    - _需求: 需求5.2, 需求5.6_

  - [ ] 8.3 知识库管理和监控界面
    - 实现PDF文档上传和ParentChildDocumentProcessor处理界面
    - 添加知识库状态监控（文档数量、索引状态、处理进度）
    - 支持实时知识库更新和向量索引重建
    - 集成系统性能监控显示（内存使用、处理时间等）
    - 编写知识库管理的集成测试
    - _需求: 需求5.3, 需求5.4_

- [ ] 9. 评估和质量保证系统
  - [ ] 9.1 Ragas自动化评估框架
    - 集成ragas评估框架，支持faithfulness、relevancy、precision指标计算
    - 创建基于现有PDF语料的标准评测数据集
    - 实现EvaluationManager类，集成ValueSeekerRAG进行端到端评估
    - 支持批量评估和结果统计分析
    - 编写评估框架的验证测试
    - _需求: 需求4.2, 需求8.1_

  - [ ] 9.2 LLM-as-a-Judge风格评估
    - 实现LLMJudge类，使用Qwen2.5进行多维度风格和质量评估
    - 设计段永平风格的评估标准和Judge Prompt模板
    - 集成到现有PromptManager，支持评估Prompt版本管理
    - 添加评估结果的统计分析和可视化报告
    - 编写LLM评估的准确性和一致性测试
    - _需求: 需求4.3, 需求8.2_

  - [ ] 9.3 系统性能监控和质量报告
    - 扩展现有日志系统，实现系统性能指标的实时监控
    - 创建PerformanceMonitor类，监控查询响应时间、内存使用等
    - 实现详细的评估报告生成功能，支持PDF和HTML格式
    - 添加异常检测和质量预警机制，集成到现有异常处理框架
    - 编写监控系统的可靠性测试
    - _需求: 需求8.4, 需求8.5_

- [ ] 10. 模型对齐训练系统
  - [ ] 10.1 对齐数据集构建和管理
    - 创建AlignmentDatasetBuilder类，支持DPO和KTO训练数据构建
    - 基于现有ValueSeekerRAG系统实现chosen/rejected对的自动生成
    - 集成段永平风格语料，构建高质量的对齐数据集
    - 添加数据质量检查、清洗和验证功能
    - 编写数据集构建的验证测试
    - _需求: 需求4.1, 需求4.6_

  - [ ] 10.2 DPO训练流程实现
    - 使用transformers和trl实现DPO训练，基于现有ModelManager
    - 配置LoRA微调参数和超参数搜索，优化训练效率
    - 集成Weights & Biases进行实验跟踪和结果可视化
    - 实现训练过程监控和模型检查点管理
    - 编写DPO训练的功能测试和性能验证
    - _需求: 需求4.1, 需求4.5_

  - [ ] 10.3 KTO训练和对比分析
    - 实现KTO对齐训练的完整流程，复用DPO训练基础设施
    - 支持DPO vs KTO的对比实验和性能分析
    - 添加训练过程的监控、早停机制和模型评估
    - 实现训练后模型的自动集成到ValueSeekerRAG系统
    - 编写KTO训练的性能测试和对比分析报告
    - _需求: 需求4.1, 需求4.4_

- [ ] 11. 部署和运维系统
  - [ ] 11.1 Docker容器化和服务编排
    - 创建生产级的Dockerfile，集成所有系统组件
    - 实现docker-compose服务编排，支持Web界面、RAG服务、向量数据库
    - 支持GPU和CPU环境的自动适配，集成现有设备检测工具
    - 配置环境变量和配置文件的容器化管理
    - 编写容器化部署的集成测试
    - _需求: 需求3.1, 需求3.3_

  - [ ] 11.2 自动化部署和环境管理
    - 开发自动化的云端部署脚本，支持一键部署
    - 实现环境检查和依赖安装自动化，集成现有setup_env.sh
    - 添加服务健康检查和故障恢复机制
    - 支持模型文件的自动下载和缓存管理
    - 编写部署脚本的可靠性测试
    - _需求: 需求3.1, 需求3.3_

  - [ ] 11.3 生产监控和运维增强
    - 扩展现有日志系统，支持生产环境的结构化日志
    - 集成系统监控和性能指标收集（CPU、内存、GPU使用率）
    - 添加告警机制和异常通知，集成到现有异常处理框架
    - 实现服务状态监控和自动重启机制
    - 编写监控系统的完整性测试
    - _需求: 需求5.4, 需求6.5, 需求8.4_

- [ ] 12. 系统集成和最终优化
  - [ ] 12.1 端到端集成测试和验证
    - 实现完整的用户场景测试，从PDF上传到投资分析回答
    - 验证所有模块间的接口和数据流（文档处理->检索->RAG->Web界面）
    - 测试并发访问和负载处理能力，验证多用户同时使用
    - 集成现有的单元测试，编写系统集成的回归测试套件
    - _需求: 需求3.4, 需求3.5, 需求6.3_

  - [ ] 12.2 性能优化和系统调优
    - 基于现有ModelManager和设备检测，优化查询响应时间至10秒以内
    - 调优内存使用控制在20GB以内，优化模型加载和卸载策略
    - 提升并发处理能力支持5+用户，优化向量检索和模型推理
    - 集成现有性能监控，编写性能优化的基准测试
    - _需求: 需求3.4, 需求3.5, 需求3.6_

  - [ ] 12.3 最终验收和项目交付
    - 执行完整的验收测试和质量检查，确保所有需求满足
    - 生成详细的项目文档和用户手册，包含部署和使用指南
    - 完成DPO vs KTO的对比分析报告，提供模型选择建议
    - 准备一键启动的部署包和演示环境，支持Docker快速部署
    - 整理项目代码和文档，准备开源发布
    - _需求: 需求4.4, 需求6.1, 需求8.3_